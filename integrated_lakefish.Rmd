---
title: "Integrated lakefish"
output: html_document
date: June 2023
---

As a start, I think we can try to redo [this analysis](https://htmlpreview.github.io/?https://github.com/emmaSkarstein/Effort_field_project/blob/main/R/Mini_test.html), but using Philip's `PointedSDMs`. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, loading packages}
library(PointedSDMs)
library(ggplot2)
library(raster)
library(INLA)
library(dplyr)
library(tidyverse)
library(sf)
```



## Downloading necessary data 
I have uploaded all the cleaned data to the "data"-folder, except for the lake polygons which are too large to include on Github. But they are easily available here: 

- **Lake polygons for Norway:** Go to https://bird.unit.no/resources/9b27e8f0-55dd-442c-be73-26781dad94c8/content (click on "Innhold"-tab at the bottom of the page to download only selected sets of lakes). The object name should be Norwegian_lakes.rds, and it should be placed in a "data" folder on the top level (the same level as the R-project).

## Loading Norway map



I think `PointedSDMs` has a function for this, so probably rewrite some of the below.

```{r, norway map}
# MAP ---------------------------------------------------------------------------------------------------------
norway <- ggplot2::map_data("world", region = "Norway(?!:Svalbard)")
norway <- setdiff(norway, dplyr::filter(norway, subregion == "Jan Mayen"))
proj <- CRS("+proj=longlat +ellps=WGS84")
norwayfill <- maps::map("world", "norway", fill=TRUE, plot=FALSE, 
                  ylim=c(58,72), xlim=c(4,32))
IDs <- sapply(strsplit(norwayfill$names, ":"), function(x) x[1])
norway.poly <- maptools::map2SpatialPolygons(norwayfill, IDs = IDs, 
                                             proj4string = proj)
```

```{r, make mesh}
# INTEGRATION STACK --------------------------------------------------------------------------------------------
#Meshpars <- list(cutoff=0.08, max.edge=c(0.6, 3), offset=c(1,1))
#Mesh <- MakeSpatialRegion(data=NULL, bdry=norway.poly, 
#                                       meshpars=Meshpars,
#                                       proj = proj)

mesh <- inla.mesh.2d(boundary = inla.sp2segment(norway.poly), 
                     cutoff = 0.3, #cutoff = 0.08,
                     max.edge = c(6, 3), 
                     offset = c(1, 1), 
                     crs = proj)


plot(mesh)
```

## Setting up observation and environmental data

Next we load the observations as well as the environmental data.

```{r, loading data and covariates}
# LOADING DATA AND COVARIATES ---------------------------------------------------------------------------------

# Covariates
covariateData <- readRDS("data/environmental_covariates.RDS")
covariateData <- covariateData[complete.cases(covariateData$decimalLatitude,
                                              covariateData$decimalLongitude,
                                              covariateData$area_km2,
                                              covariateData$HFP),]
covariateData <- covariateData %>% mutate(log_area = log(area_km2)) %>% 
  dplyr::select(-c(ebint, no_vatn_lnr, eb_waterregionID))

head(covariateData)

# Choose from 
# "decimalLatitude", "decimalLongitude",
# "area_km2", "perimeter_m", "distance_to_road", 
# "eurolst_bio10", "catchment_area_km2", "SCI", "HFP"
Use <- c("decimalLongitude","decimalLatitude", "log_area", #"perimeter_m", 
         "eurolst_bio10", "SCI")

Covariates <- SpatialPointsDataFrame(coords = covariateData[,c("decimalLongitude","decimalLatitude")],
                                     data = covariateData[,Use], 
                                     proj4string = proj)
Covariates@data <- data.frame(apply(Covariates@data, 2, scale))  # scale the covariates

cov_pixel <- SpatialPixelsDataFrame(
  points = covariateData[,c("decimalLongitude","decimalLatitude")],
  data = covariateData[,Use], 
  proj4string = proj, tol = 0.340571)

cov_pixel@data <- data.frame(apply(cov_pixel@data, 2, scale))  # scale the covariates
cov_raster <- rasterize(cov_pixel, raster(cov_pixel)) %>% dropLayer('ID')

# Observations
Data_survey_df <- readRDS("data/survey_clean_new.rds") 
Data_artsobs_df <- readRDS("data/artsobs_clean_new.rds")

MakeSpDF <- function(df){
  proj <- CRS("+proj=longlat +ellps=WGS84")
  sp_df <- SpatialPointsDataFrame(coords = df[,c("decimalLongitude","decimalLatitude")], 
                                  data = df[,c("occurrenceStatus","species")],
                                  proj4string = proj)
  colnames(sp_df@coords) = c("x", "y")
  sp_df
}
```

```{r, making spatial data frames}
# Separating by species:
perch_survey <- Data_survey_df %>% 
  filter(grepl('Perca_fluviatilis', species)) %>% 
  MakeSpDF()
trout_survey <- Data_survey_df %>% 
  filter(grepl('Salmo_trutta', species)) %>% 
  MakeSpDF()
char_survey <- Data_survey_df %>% 
  filter(grepl('Salvelinus_alpinus', species)) %>% 
  MakeSpDF()
pike_survey <- Data_survey_df %>% 
  filter(grepl('Esox_lucius', species)) %>% 
  MakeSpDF()

perch_artsobs <- Data_artsobs_df %>% 
  filter(grepl('Perca_fluviatilis', species)) %>% 
  MakeSpDF()
trout_artsobs <- Data_artsobs_df %>% 
  filter(grepl('Salmo_trutta', species)) %>% 
  MakeSpDF()
char_artsobs <- Data_artsobs_df %>% 
  filter(grepl('Salvelinus_alpinus', species)) %>% 
  MakeSpDF()
pike_artsobs <- Data_artsobs_df %>% 
  filter(grepl('Esox_lucius', species)) %>% 
  MakeSpDF()

# All four species:
four_fish_artsobs <- Data_artsobs_df %>%
  MakeSpDF()
four_fish_survey <- Data_survey_df %>%
  MakeSpDF()

# Can maybe take this away after switching to new data. Check:
unique(four_fish_artsobs$species)
unique(four_fish_survey$species)
#four_fish_survey <- four_fish_survey[four_fish_survey$species == unique(four_fish_artsobs$species),]
```

## Fitting the model
```{r, fitting a single-species model}
trout_setup <- intModel(trout_artsobs, 
                        trout_survey,
                        spatialCovariates = cov_raster,
                        Coordinates = c("x", "y"), 
                        Mesh = mesh, 
                        responsePA = "occurrenceStatus",
                        responseCounts = "occurenceStatus",
                        Projection = proj)
trout_setup$specifySpatial(sharedSpatial = TRUE, 
                           prior.range = c(10, 0.1),
                           prior.sigma = c(0.1, 0.1))
trout_setup$addBias("trout_artsobs")

trout_model <- fitISDM(trout_setup)

summary(trout_model)

#saveRDS(trout_model, "results/trout_model.rds")
```


```{r, plotting the trout model}
projections <- predict(trout_model, mesh = mesh, mask = norway.poly, 
                       spatial = TRUE,
                       fun = 'linear', n.samples = 1000)

plot(projections, whattoplot = 'mean', 
     colourLow = 'orange', colourHigh = 'dark red') 
  
```


# Joint model for four fish species



```{r, fitting four fish data, eval = FALSE}
#cov_raster <- dropLayer(cov_raster, 'ID')

four_fish_setup <- intModel(
  four_fish_survey,               # Survey data
  four_fish_artsobs,              # Citizen science data
  spatialCovariates = cov_raster, # Covariates
  speciesName = "species",        # The column containing species name
  speciesSpatial = TRUE,          # Should the species have their own sp. field?
  Coordinates = c("x", "y"),      
  Mesh = mesh, 
  Projection = proj)

# Add bias field (shared across all species)
four_fish_setup$addBias("four_fish_artsobs")

four_fish_model <- fitISDM(four_fish_setup)

summary(four_fish_model)
saveRDS(four_fish_model, "results/four_fish_model.rds")

```

