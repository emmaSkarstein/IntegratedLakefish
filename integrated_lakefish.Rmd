---
title: "Integrated lakefish"
output: html_document
date: August 2023
---

Last updated: `r format(Sys.Date(), "%B %d %Y")` at `r format(Sys.time(), "%H:%M:%S")`.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading packages:
```{r, loading packages, message = FALSE}
#devtools::install_github("PhilipMostert/PointedSDMs")
library(PointedSDMs) # model fitting
library(ggplot2)     # plotting
library(raster)      # ???? Model fitting fails if I exclude this
library(mapproj)     # map options for plotting
library(INLA)        # functions for specifying mesh
library(dplyr)       # data handling
#library(tidyverse)   
library(sf)          # spatial stuff
```

Toggle which model to run: 
```{r}
run_trout_model <- FALSE
run_four_fish_model <- TRUE
```

## Downloading data

Before you run this file, make sure you have the following files:

- `data/artsobs_clean_new.rds`
- `data/survey_clean_new.rds`
- `data/environmental_covariates.rds`
- `data/Norwegian_lakes.rds`

## Loading Norway map

I think `PointedSDMs` has a function for this, so probably rewrite some of the below.

```{r, norway map}
norway <- ggplot2::map_data("world", region = "Norway(?!:Svalbard)")
norway <- setdiff(norway, dplyr::filter(norway, subregion == "Jan Mayen"))
#proj <- "+init=epsg:4326"
proj <- '+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs'
norwayfill <- maps::map("world", "norway", fill=TRUE, plot=FALSE, 
                  ylim=c(58,72), xlim=c(4,32))
IDs <- sapply(strsplit(norwayfill$names, ":"), function(x) x[1])
norway.poly <- maptools::map2SpatialPolygons(norwayfill, IDs = IDs, 
                                             proj4string = CRS(proj))
```

```{r, make mesh}
mesh <- inla.mesh.2d(boundary = inla.sp2segment(norway.poly), 
                     cutoff = 0.3, #cutoff = 0.08,
                     max.edge = c(6, 3), 
                     offset = c(1, 1),
                     crs = st_crs(proj))
#plot(mesh)
```

## Setting up observation and environmental data

Next we load the observations as well as the environmental data.

```{r, loading covariates}
# Covariates
covariates_raw <- readRDS("data/environmental_covariates.RDS")

covariates <- covariates_raw %>% 
  # Log-transform area of lake
  dplyr::mutate(log_area = log(area_km2)) %>% 
  # Remove some uninformative variables
  dplyr::select(-c(ebint, no_vatn_lnr, eb_waterregionID)) #%>% 
  # # Center some of the covariates
  # dplyr::mutate(across(c(log_area, perimeter_m, distance_to_road, 
  #                        eurolst_bio10, catchment_area_km2, SCI, HFP), 
  #                      ~ c(scale(., scale = FALSE))))


# Choose from 
# "decimalLatitude", "decimalLongitude",
# "log_area", "perimeter_m", "distance_to_road", 
# "eurolst_bio10", "catchment_area_km2", "SCI", "HFP"

Use <- c("decimalLongitude",#"decimalLatitude", 
         "log_area","eurolst_bio10")#, "SCI")

cov_pixel <- SpatialPixelsDataFrame(
  points = covariates[,c("decimalLongitude","decimalLatitude")],
  data = covariates[,Use], 
  proj4string = CRS(proj), tol = 0.340571)

# Scale covariates and convert to terra::rast
cov_raster <- scale(terra::rast(cov_pixel))
  
#rasterize(cov_pixel, raster(cov_pixel)) %>% dropLayer('ID')

#cov_raster$log_area %>% plot()
#cov_raster$log_area[is.na(cov_raster$log_area)] <- -100

```


```{r, loading observation data}
# Observations
four_fish_survey <- readRDS("data/survey_clean_new.rds") 
four_fish_artsobs <- readRDS("data/artsobs_clean_new.rds")

# Extracting the trout data:
trout_survey <- four_fish_survey %>% 
  filter(grepl('Salmo_trutta', species))
trout_artsobs <- four_fish_artsobs %>% 
  filter(grepl('Salmo_trutta', species))
```


## Fitting a single species model

Status: Works and produces model object, but get message about vb.correction, so maybe model fit is not good?

```{r, fitting a single-species model, eval = run_trout_model}
trout_setup <- intModel(trout_artsobs, 
                        trout_survey,
                        spatialCovariates = cov_raster,
                        Coordinates = c("decimalLongitude", "decimalLatitude"), 
                        Mesh = mesh, 
                        pointsSpatial = "copy",
                        responsePA = "occurrenceStatus",
                        Projection = proj)
trout_setup$specifySpatial(sharedSpatial = TRUE, 
                           prior.range = c(10, 0.1),
                           prior.sigma = c(0.1, 0.1))
trout_setup$addBias("trout_artsobs")

trout_model <- fitISDM(trout_setup, 
                       options = list(control.inla=list(int.strategy = 'eb',
                                                        cmin = 0),
                                      safe = TRUE,
                                      inla.mode = 'experimental'))

saveRDS(trout_model, "results/trout_model.rds")
trout_model <- readRDS("results/trout_model.rds")
summary(trout_model)
```



```{r, plotting shared field from the trout model, eval = run_trout_model}
# Predict shared field
trout_sharedfield <- predict(trout_model, mesh = mesh, mask = norway.poly, format = 'sp',
                             spatial = TRUE, fun = 'linear', n.samples = 1000)

saveRDS(trout_sharedfield, "results/trout_sharedfield.rds")
trout_sharedfield <- readRDS("results/trout_sharedfield.rds")

# Plot shared spatial field
ggplot() +
  gg(trout_sharedfield$predictions) +
  plot_preferences
```


```{r, plotting bias field from the trout model, eval = run_trout_model}
# Predict biasfield
trout_biasfield <- predict(trout_model, mesh = mesh, mask = norway.poly, format = 'sp',
                           biasfield = TRUE, #datasets = trout_artsobs,
                           fun = 'linear', n.samples = 1000) # Should "spatial" be false here?

saveRDS(trout_biasfield, "results/trout_biasfield.rds")
trout_biasfield <- readRDS("results/trout_biasfield.rds")

# Plot biasfield
ggplot() +
  gg(trout_biasfield$biasFields$trout_artsobs) +
  plot_preferences
```


# Joint model for four fish species

STATUS: Works! But needs to be run on syvert1

For this model we have:

  - One bias field, based on CS data and common across all species
  - Four shared fields, shared across the data sets (survey/citizen science), but separate for each fish species.
  
```{r, fitting four fish data, eval = run_four_fish_model}
four_fish_setup <- intModel(
  four_fish_survey,                    # Survey data
  four_fish_artsobs,                   # Citizen science data
  spatialCovariates = cov_raster,      # Covariates
  speciesName = "species",             # The column containing species name
  speciesSpatial = TRUE,               # Should the species have their own sp. field?
  Coordinates = c("decimalLongitude", "decimalLatitude"), # Names of the coordinate variables
  responsePA = "occurrenceStatus",     # Name of the response column
  pointsSpatial = "copy",              # Use INLA's "copy" feature to create the shared spatial field
  Mesh = mesh,                         # inla mesh object
  Projection = proj)                   # CRS for points and covariates

# Set prior for shared spatial field
four_fish_setup$specifySpatial(sharedSpatial = TRUE, 
                           prior.range = c(10, 0.1),
                           prior.sigma = c(0.1, 0.1))

# Add bias field (shared across all species)
four_fish_setup$addBias("four_fish_artsobs") 

four_fish_model <- fitISDM(four_fish_setup, 
                           options =
                             list(control.inla=list(int.strategy = 'eb',
                                                    cmin = 0),
                                  safe = TRUE,
                                  inla.mode = 'experimental'))

summary(four_fish_model)
saveRDS(four_fish_model, "results/four_fish_model.rds")

four_fish_model <- readRDS("results/four_fish_model.rds")
```

Once the model has been fit, we can look at the predictions from the species-specific shared fields and the bias field.

First, we define a function to predict and plot the species-specific shared field for each of the species.

```{r, plotting shared fields from the four fish model}
predict_species <- function(model, species, mask, mesh){
  # Predict shared field
  sharedfield <- predict(model, 
                         mesh = mesh, 
                         mask = mask, 
                         format = 'sp',
                         spatial = TRUE, 
                         fun = 'linear', 
                         species = species,
                         n.samples = 1000)
  
  file_name <- paste0("results/sharedfield_", species, ".rds")
  saveRDS(sharedfield, file_name)
  
  return(sharedfield)
}

plot_species <- function(predictions, species){
  # Plot shared spatial field
  p <- ggplot() +
    gg(predictions$speciesPredictions[[species]]) +
    labs(title = species) +
    coord_map() +
    xlab("Longitude") +
    ylab("Latitude") +
    theme_minimal()
  return(p)
}
```


```{r, predict spatial fields for all four fish species, eval = run_four_fish_model}
fishes <- c("Salmo_trutta", "Perca_fluviatilis", 
            "Esox_lucius", "Salvelinus_alpinus")
prediction_list <- list()
for(fish in fishes) {
  prediction_list[[fish]] <- predict_species(
    model = four_fish_model,
    mesh = mesh,
    mask = norway.poly,
    species = fish
  )
}
```

```{r, plot spatial fields for all four fish species, eval = run_four_fish_model}
plot_list <- list()
fishes <- c("Salmo_trutta", "Perca_fluviatilis", 
            "Esox_lucius", "Salvelinus_alpinus")
for(fish in fishes) {
  plot_list[[fish]] <- plot_species(
    predictions = readRDS(paste0("results/sharedfield_", fish, ".rds")),
    species = fish
  )
}

library(patchwork)
purrr::reduce(plot_list, `|`)
```

And finally we plot the bias field, which is shared between all the fish, as it describes the human sampling more than the distribution of the fish.

```{r, plotting bias field from the four fish model, eval = run_four_fish_model}
# Predict biasfield
four_fish_biasfield <- predict(four_fish_model, mesh = mesh, 
                               mask = norway.poly, format = 'sp',
                               biasfield = TRUE,
                               fun = 'linear', n.samples = 1000) # Should "spatial" be false here?

saveRDS(four_fish_biasfield, "results/four_fish_biasfield.rds")
four_fish_biasfield <- readRDS("results/four_fish_biasfield.rds")

# Plot biasfield
ggplot() +
  gg(four_fish_biasfield$biasFields$four_fish_artsobs) +
  labs(title = "Bias field") +
  coord_map() +
  theme_minimal()
```




Finished knitting at: `r format(Sys.Date(), "%B %d %Y")` at `r format(Sys.time(), "%H:%M:%S")`.
